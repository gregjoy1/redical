# RediCal

## Design doc/notes

### Query events with crude/adapted iCal notation

```
OLD
---

FIND FIRST-OF-GROUP (UUID) WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-GEO-DIST-DTSTART LIMIT 50;
FIND ALL-OF-GROUP (RELATED-TO;RELTYPE=PARENT) WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-GEO-DIST-DTSTART LIMIT 50;
FIND ALL-OF-GROUP (RELATED-TO;RELTYPE=PARENT) WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART LIMIT 50;
FIND ALL-OF-GROUP (RELATED-TO;RELTYPE=PARENT) WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART-GEO-DIST LIMIT 50;

FIND FIRST WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-GEO-DIST-DTSTART LIMIT 50;
FIND ALL WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART-GEO-DIST LIMIT 50;
FIND ALL WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART LIMIT 50;

NEW
---

FIND INSTANCES WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-GEO-DIST-DTSTART FROM DTSTART:19970902T090000Z UNTIL DTSTART:19971002T090000Z LIMIT 50;
FIND INSTANCES WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-GEO-DIST-DTSTART FROM DTEND:19970902T090000Z UNTIL DTEND:19971002T090000Z LIMIT 50;
FIND INSTANCES WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART LIMIT 50;
FIND INSTANCES WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART-GEO-DIST LIMIT 50;

FIND INSTANCES WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-GEO-DIST-DTSTART LIMIT 50;
FIND INSTANCES WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART-GEO-DIST LIMIT 50;
FIND INSTANCES WHERE (CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO AND RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART LIMIT 50;
FIND INSTANCES FROM DTSTART:19970902T090000Z UUID:UUID_ONE UNTIL DTSTART:19971002T090000Z ;
FIND INSTANCES FROM-INC DTSTART:19970902T090000Z UUID:UUID_ONE UNTIL-INC DTSTART:19971002T090000Z ;

NEW2
----

'CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO RELATED-TO;RELTYPE=PARENT:PARENT_UUID GEO;DIST=3KM:48.85299;2.36885' SORTBY DTSTART GEO:48.85299;2.36885 LIMIT 50;
'(CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO RELATED-TO;RELTYPE=PARENT:PARENT_UUID GEO;DIST=3KM:48.85299;2.36885)' SORTBY DTSTART GEO:48.85299;2.36885  LIMIT 50;
'CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO & (RELATED-TO;RELTYPE=PARENT:PARENT_UUID | GEO;DIST=3KM:48.85299;2.36885)' SORTBY DTSTART GEO:48.85299;2.36885 LIMIT 50;

///

(CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART-GEO-DIST LIMIT 50;
(CATEGORIES;OP=ALL:CATEGORY_ONE,CATEGORY_TWO RELATED-TO;RELTYPE=PARENT:PARENT_UUID AND GEO;DIST=3KM:48.85299;2.36885) ORDER-BY-DTSTART LIMIT 50;
FIND INSTANCES FROM DTSTART:19970902T090000Z UUID:UUID_ONE UNTIL DTSTART:19971002T090000Z ;
FIND INSTANCES FROM-INC DTSTART:19970902T090000Z UUID:UUID_ONE UNTIL-INC DTSTART:19971002T090000Z ;

NEW3
----

X-FROM:19971002T090000Z        => X-FROM;PROP=DTSTART;OP=GT;TZID=UTC:19971002T090000
X-FROM;OP=GTE:19971002T090000Z => X-FROM;PROP=DTSTART;OP=GTE;TZID=UTC:19971002T090000

X-FROM;PROP=DTSTART;OP=GT;TZID=Europe/London;UUID=Event_UUID:19971002T090000
X-FROM;PROP=DTSTART;OP=GTE;TZID=Europe/London;UUID=Event_UUID:19971002T090000

X-FROM-DTSTART-GT;TZID=Europe/London:19971002T090000Z
X-FROM-DTSTART-GTE;TZID=Europe/London;UUID=Event_UUID:19971002T090000Z
X-FROM-DTEND-GT;TZID=Europe/London:19971002T090000Z
X-FROM-DTEND-GTE;TZID=Europe/London:19971002T090000Z

X-UNTIL:19971002T090000Z        => X-UNTIL;PROP=DTSTART;OP=LT;TZID=UTC:19971002T090000
X-UNTIL;OP=LTE:19971002T090000Z => X-UNTIL;PROP=DTSTART;OP=LTE;TZID=UTC:19971002T090000

X-UNTIL;PROP=DTSTART;OP=LT;TZID=Europe/London;UUID=Event_UUID:19971002T090000
X-UNTIL;PROP=DTSTART;OP=LTE;TZID=Europe/London;UUID=Event_UUID:19971002T090000

X-UNTIL-DTSTART-LT;TZID=Europe/London:19971002T090000Z
X-UNTIL-DTSTART-LTE;TZID=Europe/London;UUID=Event_UUID:19971002T090000Z
X-UNTIL-DTEND-LT;TZID=Europe/London:19971002T090000Z
X-UNTIL-DTEND-LTE;TZID=Europe/London:19971002T090000Z

X-LIMIT:50

X-CATEGORIES:CATEGORY_ONE,CATEGORY_TWO  => X-CATEGORIES;OP=AND:CATEGORY_ONE,CATEGORY_TWO
X-RELATED-TO;RELTYPE=PARENT:PARENT_UUID => X-RELATED-TO;OP=AND;RELTYPE=PARENT:PARENT_UUID

X-GEO;DIST=3KM:48.85299;2.36885

X-ORDER-BY:DTSTART
X-ORDER-BY;GEO=48.85299;2.36885:DTSTART-GEO-DIST
X-ORDER-BY;GEO=48.85299;2.36885:GEO-DIST-DTSTART
```

### Test events

```
rdcl.cal_set CALENDAR_UUID_ONE
rdcl.evt_set CALENDAR_UUID_ONE ONLINE_EVENT_MON_WED 'NAME:Online Event on Mondays and Wednesdays at 4:00PM RRULE:FREQ=WEEKLY;UNTIL=20211231T170000Z;INTERVAL=1;BYDAY=MO,WE DTSTART:20201231T160000Z DTEND:20201231T170000Z RELATED-TO;RELTYPE=PARENT:PARENT_UUID CATEGORIES:CATEGORY_ONE,CATEGORY TWO'
rdcl.evt_set CALENDAR_UUID_ONE EVENT_IN_OXFORD_MON_WED 'NAME:Event in Oxford on Mondays and Wednesdays at 5:00PM RRULE:FREQ=WEEKLY;COUNT=3;INTERVAL=1;BYDAY=MO,WE DTSTART:20201231T170000Z DTEND:20201231T173000Z RELATED-TO;RELTYPE=PARENT:PARENT_UUID CATEGORIES:CATEGORY_ONE,"CATEGORY TWO" GEO:51.751365550307604;-1.2601196837753945'
rdcl.evt_set CALENDAR_UUID_ONE EVENT_IN_READING_TUE_THU 'NAME:Event in Reading on Tuesdays and Thursdays at 6:00PM RRULE:FREQ=WEEKLY;COUNT=3;INTERVAL=1;BYDAY=TU,TH DTSTART:20201231T180000Z DTEND:20201231T183000Z RELATED-TO;RELTYPE=PARENT:PARENT_UUID CATEGORIES:CATEGORY_ONE,CATEGORY_THREE GEO:51.45442303961853;-0.9792277140273513'
rdcl.evt_set CALENDAR_UUID_ONE EVENT_IN_LONDON_TUE_THU 'NAME:Event in London on Tuesdays and Thursdays at 6:30PM RRULE:FREQ=WEEKLY;COUNT=3;INTERVAL=1;BYDAY=TU,TH DTSTART:20201231T183000Z DTEND:20201231T190000Z RELATED-TO;RELTYPE=PARENT:PARENT_UUID CATEGORIES:CATEGORY_ONE,CATEGORY_FOUR GEO:51.50740017561507;-0.12698231869919185'
rdcl.evt_set CALENDAR_UUID_ONE EVENT_IN_CHELTENHAM_TUE_THU 'NAME:Event in Cheltenham on Tuesdays and Thursdays at 6:30PM RRULE:FREQ=WEEKLY;COUNT=3;INTERVAL=1;BYDAY=TU,TH DTSTART:20201231T183000Z DTEND:20201231T190000Z RELATED-TO;RELTYPE=PARENT:PARENT_UUID CATEGORIES:CATEGORY_ONE,CATEGORY_FOUR GEO:51.89936851432488;-2.078357552295971'
rdcl.evt_set CALENDAR_UUID_ONE EVENT_IN_BRISTOL_TUE_THU 'NAME:Event in Bristol on Tuesdays and Thursdays at 6:30PM RRULE:FREQ=WEEKLY;COUNT=3;INTERVAL=1;BYDAY=TU,TH DTSTART:20201231T183000Z DTEND:20201231T190000Z RELATED-TO;RELTYPE=PARENT:PARENT_UUID CATEGORIES:CATEGORY_ONE,CATEGORY_FOUR GEO:51.454481838260214;-2.588329192623361'

rdcl.cal_query CALENDAR_UUID_ONE "X-FROM;PROP=DTSTART;OP=GTE;TZID=UTC:20201231T153000Z X-LIMIT:10 X-GEO;DIST=30KM:51.78575190687863;-1.4850309383885298"
rdcl.cal_query CALENDAR_UUID_ONE "X-FROM;PROP=DTSTART;OP=GTE;TZID=UTC:20201231T153000Z X-LIMIT:10 X-ORDER-BY;GEO=51.78575190687863;-1.4850309383885298:GEO-DIST-DTSTART"
rdcl.cal_query CALENDAR_UUID_ONE "X-FROM;PROP=DTSTART;OP=GTE;TZID=UTC:20201231T153000Z X-LIMIT:10 X-ORDER-BY;GEO=51.78575190687863;-1.4850309383885298:DTSTART-GEO-DIST"
```

### Specify events with crude iCal notation

#### Event specific properties

##### UID

Use key as UID for event (indexed).

##### CATEGORIES

Arbituary text string list for searching (indexed).

##### DTSTART, RRULE, EXRULE, EXDATE, RDATE, TZID

Using [rust-rrule crate](https://github.com/fmeringdal/rust-rrule):

Parse and store each of these individually as `rrule::RRule`/`chrono::{DateTime, TimeZone}` and later concat into `rrule::RRuleSet` for validation/expansion.

Resulting in indexed `DTSTART` list for all event occurrences within a defined period.

##### CLASS

Either `PUBLIC`/`PRIVATE` to denote un/published status for querying.

##### IMAGE

URL to a hosted image (non-indexed).

##### DESCRIPTION, SUMMARY

Free text fields (non-indexed).

##### RELATED-TO

Multi dimensional tags, for searching events by their relationships:

Example to indicate event with queryable:
* Sibling relationship to other events sharing the same `FREE_TEXT_EVENT_REF`
* Child/Membership relationship to calendars identified with either `FREE_TEXT_CALENDAR_X_REF`, or `FREE_TEXT_CALENDAR_Y_REF`
* Proprietary vendor specific relationship to vendor specific entity identified with either `PROPRIETARY_VENDOR_ENTITY_REF`

'UID:uid1@example.com DTSTAMP:19970714T170000Z ORGANIZER;CN=John Doe:MAILTO:john.doe@example.com DTSTART:19970714T170000Z DTEND:19970715T040000Z SUMMARY:Bastille Day Party GEO:48.85299;2.36885'

```
RELATED-TO;RELTYPE=SIBLING:FREE_TEXT_EVENT_REF

RELATED-TO;RELTYPE=PARENT:FREE_TEXT_CALENDAR_X_REF,FREE_TEXT_CALENDAR_Y_REF

# RELATED-TO;RELTYPE=PARENT default if unspecified
RELATED-TO;FREE_TEXT_CALENDAR_X_REF,FREE_TEXT_CALENDAR_Y_REF

RELATED-TO;RELTYPE=X-VENDOR-RELATIONSHIP:PROPRIETARY_VENDOR_ENTITY_REF
```

##### DTEND, DURATION

Either (not both) defined to establish an extrapolated `DTEND` for each event occurrence (potentially indexed).

##### LOCATION

Free text field for location information (non-indexed).

##### GEO

Defined long/lat for event (indexed).

##### CONTACT, ORGANISER

Free text field for contact information for the event (non-indexed).

#### Event Instance specific properties

##### UID

Pulled from event UUID.

##### CATEGORIES

Arbituary overridable text string list for searching (indexed).

##### CLASS

Either `PUBLIC`/`PRIVATE` to denote un/published overridable status for querying.

##### IMAGE

Overridable URL to a hosted image (non-indexed).

##### DESCRIPTION, SUMMARY

overridable free text fields (non-indexed).

##### RELATED-TO

Multi dimensional tags, for searching event instances by their relationships:

Example to indicate event instance with queryable:
* Overriden Child/Membership relationship to calendars identified with either `FREE_TEXT_CALENDAR_X_REF`, or `FREE_TEXT_CALENDAR_Y_REF`
* Overridden proprietary vendor specific relationship to vendor specific entity identified with either `PROPRIETARY_VENDOR_ENTITY_REF`

```
RELATED-TO;RELTYPE=PARENT:FREE_TEXT_CALENDAR_X_REF,FREE_TEXT_CALENDAR_Y_REF

# RELATED-TO;RELTYPE=PARENT default if unspecified
RELATED-TO;FREE_TEXT_CALENDAR_X_REF,FREE_TEXT_CALENDAR_Y_REF

RELATED-TO;RELTYPE=X-VENDOR-RELATIONSHIP:PROPRIETARY_VENDOR_ENTITY_REF
```

##### DTEND, DURATION

Overridable either (not both) defined to establish an extrapolated `DTEND` for each event occurrence (potentially indexed).

##### LOCATION

Overridable free text field for location information (non-indexed).

##### GEO

Overridable defined long/lat for event (indexed).

##### CONTACT, ORGANISER

Overridable free text field for contact information for the event (non-indexed).

##### RECURRENCE-ID

Generated reference to occurrence date/date-time:

```
RECURRENCE-ID;VALUE=DATE:19960401
RECURRENCE-ID;VALUE=DATE-TIME:19960120T120000Z
```
